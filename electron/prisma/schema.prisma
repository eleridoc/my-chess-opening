// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ExternalSite {
  CHESSCOM
  LICHESS
}

enum GameSpeed {
  BULLET
  BLITZ
  RAPID
  CLASSICAL
}

enum PlayerColor {
  WHITE
  BLACK
}

enum ImportStatus {
  SUCCESS
  FAILED
  PARTIAL
}

//
// Minimal persistent logging for imports.
// We intentionally keep it lightweight (no per-game "OK" logs in DB).
//
enum ImportLogLevel {
  INFO
  WARN
  ERROR
}

model AccountConfig {
  id        String       @id @default(cuid())
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  site      ExternalSite
  username  String
  isEnabled Boolean      @default(true)
  lastSyncAt DateTime?

  games      Game[]
  importRuns ImportRun[]

  @@unique([site, username])
}

model Game {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owner account (we only store games where this account is a player)
  accountConfigId String
  accountConfig   AccountConfig @relation(fields: [accountConfigId], references: [id], onDelete: Cascade)

  // External identity / anti-duplicates
  site       ExternalSite
  externalId String
  siteUrl    String?

  // Metadata
  playedAt   DateTime
  rated      Boolean
  variant    String
  speed      GameSpeed
  timeControl      String
  initialSeconds   Int
  incrementSeconds Int

  result      String
  termination String?
  eco         String?
  opening     String?

  // Result as numeric key for fast aggregation:
  //  1 = white win, 0 = draw, -1 = black win
  resultKey Int

  // Raw data
  pgn     String
  pgnHash String?

  players GamePlayer[]
  moves   GameMove[]

  // Players snapshot (objective, from PGN)
  whiteUsername   String
  blackUsername   String
  whiteElo        Int?
  blackElo        Int?
  whiteRatingDiff Int?
  blackRatingDiff Int?

  // Import owner perspective (relative to AccountConfig.username)
  myColor            PlayerColor
  myUsername         String
  opponentUsername   String
  myElo              Int?
  opponentElo        Int?
  myRatingDiff       Int?
  opponentRatingDiff Int?

  @@unique([accountConfigId, site, externalId])
  @@index([site, externalId])
  @@index([accountConfigId, playedAt])
  @@index([accountConfigId, myColor])
  @@index([playedAt])
  @@index([eco])
  @@index([resultKey])
}

model GamePlayer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gameId String
  game   Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  color      PlayerColor
  username   String
  elo        Int?
  ratingDiff Int?

  @@unique([gameId, color])
  @@index([username])
}

model GameMove {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gameId String
  game   Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  // 1,2,3... (half-moves / ply)
  ply Int
  san String

  // Position matching (AFTER)
  uci          String?
  fen          String
  positionHash String

  // Position matching (BEFORE): "moves played from this position"
  positionHashBefore String

  // Optional debug field
  fenBefore String?

  clockMs Int?

  @@unique([gameId, ply])

  // Fast lookup by position
  @@index([positionHash])
  @@index([gameId, positionHash])
  @@index([positionHashBefore])
  @@index([positionHashBefore, uci])
}

model ImportRun {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // One ImportRun is tied to one AccountConfig (per-account run).
  accountConfigId String
  accountConfig   AccountConfig @relation(fields: [accountConfigId], references: [id], onDelete: Cascade)

  startedAt  DateTime @default(now())
  finishedAt DateTime?
  status     ImportStatus @default(SUCCESS)

  // Minimal error summary (full details go to ImportLogEntry.data)
  errorMessage String?

  // Minimal counters for UI (per-account)
  gamesFound    Int @default(0)
  gamesInserted Int @default(0)
  gamesSkipped  Int @default(0)
  gamesFailed   Int @default(0)

  logs ImportLogEntry[]

  @@index([accountConfigId, startedAt])
}

model ImportLogEntry {
  id        String         @id @default(cuid())
  createdAt DateTime       @default(now())

  importRunId String
  importRun   ImportRun    @relation(fields: [importRunId], references: [id], onDelete: Cascade)

  level   ImportLogLevel @default(INFO)
  message String

  // Optional context (helps diagnose without being too verbose)
  scope     String?       // "RUN" | "FETCH" | "PARSE" | "PERSIST" | ...
  site      ExternalSite?
  username  String?
  externalId String?
  url       String?

  // Optional extra details as JSON string (error stack, http status, etc.)
  data String?

  @@index([importRunId, createdAt])
  @@index([level, createdAt])
}
