// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ExternalSite {
  CHESSCOM
  LICHESS
}

enum GameSpeed {
  BULLET
  BLITZ
  RAPID
  CLASSICAL
}

enum PlayerColor {
  WHITE
  BLACK
}

enum ImportStatus {
  SUCCESS
  FAILED
  PARTIAL
}

model AccountConfig {
  id        String       @id @default(cuid())
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  site      ExternalSite
  username  String
  isEnabled Boolean      @default(true)
  lastSyncAt DateTime?

  games     Game[]
  importRuns ImportRun[]

  @@unique([site, username])
}

model Game {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owner account (we only store games where this account is a player)
  accountConfigId String
  accountConfig   AccountConfig @relation(fields: [accountConfigId], references: [id], onDelete: Cascade)

  // External identity / anti-duplicates
  site       ExternalSite
  externalId String
  siteUrl    String?

  // Metadata
  playedAt   DateTime
  rated      Boolean
  variant    String
  speed      GameSpeed
  timeControl      String
  initialSeconds   Int
  incrementSeconds Int

  result      String
  termination String?
  eco         String?
  opening     String?

  // Result as numeric key for fast aggregation:
  //  1 = white win, 0 = draw, -1 = black win
  resultKey Int

  // Raw data
  pgn     String
  pgnHash String?

  players GamePlayer[]
  moves   GameMove[]

  // Players snapshot (objective, from PGN)
  whiteUsername   String
  blackUsername   String
  whiteElo        Int?
  blackElo        Int?
  whiteRatingDiff Int?
  blackRatingDiff Int?

  // Import owner perspective (relative to AccountConfig.username)
  myColor            PlayerColor
  myUsername         String
  opponentUsername   String
  myElo              Int?
  opponentElo        Int?
  myRatingDiff       Int?
  opponentRatingDiff Int?


  @@unique([site, externalId])
  @@index([accountConfigId, playedAt])
  @@index([accountConfigId, myColor])
  @@index([playedAt])
  @@index([eco])
  @@index([resultKey])
}

model GamePlayer {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gameId String
  game   Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  color      PlayerColor
  username   String
  elo        Int?
  ratingDiff Int?

  @@unique([gameId, color])
  @@index([username])
}

model GameMove {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  gameId String
  game   Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  // 1,2,3... (half-moves / ply)
  ply     Int
  san     String

  // New fields for position matching
  uci          String?
  fen          String
  positionHash String

  // BEFORE (position from which this move was played)
  positionHashBefore String

  // Optional debug field (not required for queries)
  fenBefore String?

  clockMs Int?

  @@unique([gameId, ply])

  // Fast lookup by position
  @@index([positionHash])
  @@index([gameId, positionHash])
  @@index([positionHashBefore])
  @@index([positionHashBefore, uci])
}

model ImportRun {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accountConfigId String
  accountConfig   AccountConfig @relation(fields: [accountConfigId], references: [id], onDelete: Cascade)

  startedAt  DateTime @default(now())
  finishedAt DateTime?
  status     ImportStatus @default(SUCCESS)

  errorMessage String?

  gamesFound    Int @default(0)
  gamesInserted Int @default(0)
  gamesSkipped  Int @default(0)

  @@index([accountConfigId, startedAt])
}
