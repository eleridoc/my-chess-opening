<!--
	QA Panel (Explorer / UI)

	Purpose:
	- Lightweight debug/QA surface for the Explorer feature.
	- Lets you quickly exercise core scenarios (reset/load/apply moves/navigation).
	- Shows transient session state (mode/source/ply/fen, lastError, promotion workflow).
	- Provides stress buttons and a simple smoke checklist.
	- Displays a small event log for quick inspection during dev.

	Notes:
	- This is intentionally UI-only and should not contain any domain logic.
	- All actions call methods on the page/component TS, which delegates to ExplorerFacade.
-->

<ng-container *ngIf="visible()">
	<div class="qa" [class.qa--collapsed]="collapsed()">
		<!-- Top bar (collapse/expand + title + clear) -->
		<div class="qa__top">
			<button mat-icon-button (click)="toggleCollapsed()" aria-label="Toggle QA panel">
				<mat-icon>{{ collapsed() ? 'chevron_right' : 'chevron_left' }}</mat-icon>
			</button>

			<div class="qa__title" *ngIf="!collapsed()">QA</div>

			<span class="qa__spacer"></span>

			<button mat-icon-button *ngIf="!collapsed()" (click)="clearLogs()" aria-label="Clear logs">
				<mat-icon>delete</mat-icon>
			</button>
		</div>

		<!-- Collapsible content -->
		<ng-container *ngIf="!collapsed()">
			<!-- Session snapshot + transient states (error/promotion) -->
			<div class="app-card-flat">
				<div class="app-card-flat-top">Session</div>
				<div class="app-card-flat-content">
					<mat-chip-set aria-label="Explorer session info">
						<mat-chip>Mode: {{ facade.mode() }}</mat-chip>
						<mat-chip>Source: {{ facade.source().kind }}</mat-chip>
						<mat-chip>Ply: {{ facade.ply() }}</mat-chip>
						<mat-chip>FEN: {{ fenShort() }}</mat-chip>
					</mat-chip-set>

					<!-- Last error raised by a facade action -->
					<div class="qa__error" *ngIf="facade.lastError() as err">
						<div class="qa__error-code">{{ err.code }}</div>
						<div class="qa__error-msg">{{ err.message }}</div>
					</div>

					<!-- Promotion workflow (when PROMOTION_REQUIRED is returned by the core) -->
					<div class="qa__promo" *ngIf="facade.promotionPending() as p">
						<div class="qa__promo-title">Promotion pending</div>
						<div class="qa__promo-row">{{ p.from }} → {{ p.to }}</div>
						<div class="qa__promo-actions">
							<button mat-stroked-button (click)="confirmPromotion('q')">Q</button>
							<button mat-stroked-button (click)="confirmPromotion('r')">R</button>
							<button mat-stroked-button (click)="confirmPromotion('b')">B</button>
							<button mat-stroked-button (click)="confirmPromotion('n')">N</button>
						</div>
					</div>
				</div>
			</div>

			<div class="app-card-flat">
				<div class="app-card-flat-top">Players VM</div>
				<div class="app-card-flat-content">
					<div class="qa-row qa-row--wrap">
						<button mat-stroked-button type="button" (click)="facade.toggleBoardOrientation()">
							Rotate (QA)
						</button>

						<button mat-stroked-button type="button" (click)="loadPgnWithElos()">
							Load PGN (with Elo)
						</button>
					</div>

					<div class="qa-kv">
						<div class="qa-kv__row">
							<div class="qa-kv__key">boardOrientation</div>
							<div class="qa-kv__value">{{ facade.boardOrientation() }}</div>
						</div>

						<div class="qa-kv__row">
							<div class="qa-kv__key">headers.source</div>
							<div class="qa-kv__value">
								{{ facade.dbGameSnapshot() ? 'DB' : facade.source().kind }}
							</div>
						</div>

						<div class="qa-kv__row">
							<div class="qa-kv__key">top</div>
							<div class="qa-kv__value">
								{{ qaTopSide() }} — {{ qaTopPlayer().name }}
								<span *ngIf="qaTopPlayer().elo as e"> ({{ e }})</span>
							</div>
						</div>

						<div class="qa-kv__row">
							<div class="qa-kv__key">bottom</div>
							<div class="qa-kv__value">
								{{ qaBottomSide() }} — {{ qaBottomPlayer().name }}
								<span *ngIf="qaBottomPlayer().elo as e"> ({{ e }})</span>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="app-card-flat">
				<div class="app-card-flat-top">DB Snapshot (mock)</div>

				<div class="app-card-flat-content">
					<div class="qa-row qa-row--wrap">
						<button mat-stroked-button type="button" (click)="loadDemoDbSnapshot001()">
							Load demo-001
						</button>

						<button mat-stroked-button type="button" (click)="loadDemoDbSnapshot002()">
							Load demo-002
						</button>
					</div>

					<div class="qa-kv">
						<div class="qa-kv__row">
							<div class="qa-kv__key">dbSnapshot</div>
							<div class="qa-kv__value">
								{{ facade.dbGameSnapshot() ? 'loaded' : 'null' }}
							</div>
						</div>

						<div class="qa-kv__row">
							<div class="qa-kv__key">gameId</div>
							<div class="qa-kv__value">
								{{ facade.dbGameSnapshot()?.gameId ?? '-' }}
							</div>
						</div>

						<div class="qa-kv__row">
							<div class="qa-kv__key">positionKey</div>
							<div class="qa-kv__value qa-mono">
								{{ facade.positionKey() }}
							</div>
						</div>

						<div class="qa-kv__row">
							<div class="qa-kv__key">normalizedFen</div>
							<div class="qa-kv__value qa-mono">
								{{ facade.normalizedFen() }}
							</div>
						</div>

						<div class="qa-kv__row">
							<div class="qa-kv__key">pendingDbGameId</div>
							<div class="qa-kv__value qa-mono">
								{{ facade.pendingDbGameId() ?? '-' }}
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Scenario helpers (load/reset/illegal/promotion/etc.) -->
			<div class="app-card-flat">
				<div class="app-card-flat-top">Scenarios</div>
				<div class="app-card-flat-content">
					<button mat-stroked-button (click)="loadInitial()">Reset / Initial</button>
					<button mat-stroked-button (click)="loadLongPgn()">Load long PGN</button>
					<button mat-stroked-button (click)="createVariationAtPly1()">
						Create variation (ply 1)
					</button>
					<button mat-stroked-button (click)="loadInCheckFen()">Load in-check FEN</button>
					<button mat-stroked-button (click)="tryIllegalMove()">Try illegal move</button>
					<button mat-stroked-button (click)="loadPromotionFen()">Load promotion FEN</button>
					<button mat-stroked-button (click)="triggerPromotionAttempt()">Try a7→a8</button>

					<button
						mat-stroked-button
						type="button"
						(click)="navigateExplorerWithDbGameId('demo-001')"
					>
						Go /explorer?dbGameId=demo-001
					</button>

					<button
						mat-stroked-button
						type="button"
						(click)="navigateExplorerWithDbGameId('sdfsdfgsddsggsgd')"
					>
						Go /explorer?dbGameId=sdfsdfgsddsggsgd
					</button>

					<button
						mat-stroked-button
						type="button"
						(click)="navigateExplorerWithDbGameId('cmk9td7lm00e825lo3spmn8go')"
					>
						Go /explorer?dbGameId=cmk9td7lm00e825lo3spmn8go
					</button>

					<button mat-stroked-button (click)="loadPgnWithElos()">Load PGN (with Elo)</button>
				</div>
			</div>

			<!-- Stress actions (rapid navigation spam + goto shortcuts) -->
			<div class="app-card-flat">
				<div class="app-card-flat-top">Stress actions</div>
				<div class="app-card-flat-content">
					<button mat-stroked-button (click)="prevSpam()">Prev ×30</button>
					<button mat-stroked-button (click)="nextSpam()">Next ×30</button>

					<div class="qa__goto">
						<button mat-stroked-button (click)="goToPly(0)">goToPly(0)</button>
						<button mat-stroked-button (click)="goToPly(1)">goToPly(1)</button>
						<button mat-stroked-button (click)="goToPly(2)">goToPly(2)</button>
						<button mat-stroked-button (click)="goToPly(10)">goToPly(10)</button>
					</div>
				</div>
			</div>

			<!-- Variation cycling (legacy / debug: cycles at current ply) -->
			<div class="app-card-flat">
				<div class="app-card-flat-top">Variations</div>
				<div class="app-card-flat-content">
					<div class="qa__variation-row">
						<button
							mat-stroked-button
							(click)="prevVariation()"
							[disabled]="!facade.canPrevVariation()"
						>
							Prev variation
						</button>

						<button
							mat-stroked-button
							(click)="nextVariation()"
							[disabled]="!facade.canNextVariation()"
						>
							Next variation
						</button>
					</div>

					<!-- Current variation index/count (1-based in UI) -->
					<div class="qa__variation-info" *ngIf="facade.variationInfo() as v">
						Current: {{ v.index + 1 }} / {{ v.count }}
					</div>

					<!-- No variation available at the current ply -->
					<div class="qa__variation-info" *ngIf="!facade.variationInfo()">
						No variation at current ply.
					</div>
				</div>
			</div>

			<!-- Event log (dev-only visibility) -->

			<div class="app-card-flat">
				<div class="app-card-flat-top">Event log</div>
				<div class="app-card-flat-content">
					<div class="qa__logs">
						<div class="qa__log" *ngFor="let l of logs()">
							<div class="qa__log-meta">
								<span class="qa__log-level">{{ l.level }}</span>
								<span class="qa__log-at">{{ l.at }}</span>
							</div>
							<div class="qa__log-msg">{{ l.message }}</div>
						</div>
					</div>
				</div>
			</div>
		</ng-container>
	</div>
</ng-container>
