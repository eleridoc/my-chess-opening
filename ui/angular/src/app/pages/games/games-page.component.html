<div class="app-page">
	<h1 class="page-title">My games played</h1>
	<p class="page-subtitle">The list of all the games you have played and imported.</p>

	<!-- Filters row (kept compact via app-density wrapper) -->
	<div class="app-filters app-density--5">
		<div class="app-filters__main">
			<mat-form-field appearance="fill" subscriptSizing="dynamic" class="games-search">
				<input
					matInput
					aria-label="Search"
					[ngModel]="search()"
					(ngModelChange)="onSearch($event)"
					placeholder="Search…"
				/>
			</mat-form-field>

			<button mat-stroked-button class="mat-stroked-button-d-5" type="button" (click)="reloadNow()">
				<mat-icon>refresh</mat-icon>
				Reload
			</button>
		</div>
	</div>

	<app-section-loader
		[loading]="loading()"
		mode="overlay"
		[mask]="true"
		[blocking]="true"
		label="Loading games…"
	>
		<div class="app-table-card app-table-card--compact">
			<div class="app-table-card__scroll">
				<table
					mat-table
					[dataSource]="items()"
					class="games-table"
					[trackBy]="trackById"
					matSort
					[matSortActive]="'playedAt'"
					[matSortDirection]="playedAtOrder()"
					matSortDisableClear
					(matSortChange)="onSortChange($event)"
				>
					<!-- playedAt -->
					<ng-container matColumnDef="playedAt">
						<th mat-header-cell *matHeaderCellDef mat-sort-header="playedAt">Played</th>
						<td mat-cell *matCellDef="let g">
							{{ g.playedAtIso | appIsoDateTime }}
						</td>
					</ng-container>

					<!-- site -->
					<ng-container matColumnDef="site">
						<th mat-header-cell *matHeaderCellDef>Site</th>
						<td mat-cell *matCellDef="let g">
							<!--
							We keep a real <a> element for semantics, but we prevent default navigation
							and open it via Electron (system browser) in openExternal().
						-->
							<a
								class="games-site-link"
								[class.games-site-link--disabled]="!g.externalUrl"
								[attr.href]="g.externalUrl || null"
								[attr.aria-disabled]="!g.externalUrl"
								[attr.tabindex]="g.externalUrl ? 0 : -1"
								(click)="openExternal(g.externalUrl, $event)"
							>
								{{ g.site }}
							</a>
						</td>
					</ng-container>

					<!-- white -->
					<ng-container matColumnDef="white">
						<th mat-header-cell *matHeaderCellDef>White</th>
						<td mat-cell *matCellDef="let g">
							<span class="games-player" [ngClass]="playerClasses(g, 'white')">
								<span class="games-player__name">{{ g.whiteUsername }}</span>
								<span class="games-player__elo">({{ g.whiteElo ?? '—' }})</span>
							</span>
						</td>
					</ng-container>

					<!-- black -->
					<ng-container matColumnDef="black">
						<th mat-header-cell *matHeaderCellDef>Black</th>
						<td mat-cell *matCellDef="let g">
							<span class="games-player" [ngClass]="playerClasses(g, 'black')">
								<span class="games-player__name">{{ g.blackUsername }}</span>
								<span class="games-player__elo">({{ g.blackElo ?? '—' }})</span>
							</span>
						</td>
					</ng-container>

					<!-- result -->
					<ng-container matColumnDef="result">
						<th mat-header-cell *matHeaderCellDef>Result</th>
						<td mat-cell *matCellDef="let g">{{ myResultLabel(g) }}</td>
					</ng-container>

					<!-- moves -->
					<ng-container matColumnDef="moves">
						<th mat-header-cell *matHeaderCellDef>Moves</th>
						<td mat-cell *matCellDef="let g" class="games-moves">
							{{ g.movesCount }}
						</td>
					</ng-container>

					<!-- opening -->
					<ng-container matColumnDef="opening">
						<th mat-header-cell *matHeaderCellDef>Opening</th>
						<td mat-cell *matCellDef="let g">
							<span class="games-opening">
								<!-- ECO -->
								<span *ngIf="g.ecoDetermined || g.eco" class="games-eco">
									<ng-container *ngIf="g.ecoDetermined as ecoDet; else ecoProviderOnly">
										<span
											class="games-eco-code"
											[class.games-eco-code--overridden]="!!g.eco && g.eco !== ecoDet"
											[matTooltip]="!!g.eco && g.eco !== ecoDet ? 'Provider ECO: ' + g.eco : ''"
											[matTooltipDisabled]="!(!!g.eco && g.eco !== ecoDet)"
										>
											{{ ecoDet }}
										</span>

										<span *ngIf="g.eco && g.eco !== ecoDet" class="games-eco-source">
											({{ g.eco }})
										</span>
									</ng-container>

									<ng-template #ecoProviderOnly>
										<span class="games-eco-code">{{ g.eco }}</span>
									</ng-template>
								</span>

								<!-- Opening name -->
								<span
									class="games-opening-name"
									[class.games-opening-name--deduced]="!g.opening && !!g.ecoOpeningName"
									[matTooltip]="g.ecoOpeningLinePgn || ''"
									[matTooltipDisabled]="!g.ecoOpeningLinePgn"
								>
									{{ openingLabel(g.opening ?? g.ecoOpeningName) }}
								</span>

								<span
									*ngIf="!g.opening && g.ecoOpeningName"
									class="games-opening-deduced"
									matTooltip="Deduced from ECO + moves (best-effort, may be imprecise)."
								>
									≈
								</span>
							</span>
						</td>
					</ng-container>

					<!-- speed -->
					<ng-container matColumnDef="speed">
						<th mat-header-cell *matHeaderCellDef>Speed</th>
						<td mat-cell *matCellDef="let g">{{ g.speed }}</td>
					</ng-container>

					<!-- time -->
					<ng-container matColumnDef="time">
						<th mat-header-cell *matHeaderCellDef>Time</th>
						<td mat-cell *matCellDef="let g" class="games-time-compact">
							{{ timeLabel(g.timeControl) }}
						</td>
					</ng-container>

					<!-- rated -->
					<ng-container matColumnDef="rated">
						<th mat-header-cell *matHeaderCellDef>Type</th>
						<td mat-cell *matCellDef="let g">{{ ratedLabel(g.rated) }}</td>
					</ng-container>

					<!-- actions -->
					<ng-container matColumnDef="actions">
						<th mat-header-cell *matHeaderCellDef></th>
						<td mat-cell *matCellDef="let g" class="app-table-card__actions">
							<button
								mat-icon-button
								type="button"
								(click)="openInExplorer(g.id)"
								(keydown.enter)="openInExplorer(g.id)"
								(keydown.space)="openInExplorer(g.id)"
								aria-label="Open in Explorer"
								matTooltip="Open in Explorer"
							>
								<mat-icon aria-hidden="true">travel_explore</mat-icon>
							</button>
						</td>
					</ng-container>

					<!-- Sticky header is applied to the header row (one single place) -->
					<tr
						mat-header-row
						*matHeaderRowDef="displayedColumns"
						class="app-table-card__sticky-header"
					></tr>
					<tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
				</table>

				<div *ngIf="!loading() && items().length === 0" class="games-empty">No games.</div>
			</div>

			<!-- Paginator is outside scroll area: always visible -->
			<mat-paginator
				class="app-table-card__paginator"
				[length]="total()"
				[pageIndex]="page() - 1"
				[pageSize]="pageSize()"
				[pageSizeOptions]="[25, 50, 100, 200]"
				(page)="onPage($event)"
			></mat-paginator>
		</div>
	</app-section-loader>
</div>
