<div class="app-page import-page">
	<h1 class="page-title">Import games</h1>
	<p class="page-subtitle">
		Import your games account-by-account with live progress and per-account results.
	</p>

	<!-- Controls card: actions + rules + current batch summary -->
	<div class="app-card-flat import__controls">
		<div class="app-card-flat-top">Import</div>

		<div class="app-card-flat-content">
			<div class="import__controls-row">
				<button
					mat-flat-button
					type="button"
					class="mat-flat-button-d-5"
					(click)="importAll()"
					[disabled]="actionsDisabled()"
					[matTooltip]="
						importState.isImporting()
							? 'Import already running'
							: 'Start import for all enabled accounts'
					"
				>
					<mat-icon aria-hidden="true">download</mat-icon>
					<span>{{ importState.isImporting() ? 'Importing…' : 'Import all accounts' }}</span>
				</button>

				<button
					mat-stroked-button
					type="button"
					class="mat-stroked-button-d-5"
					(click)="refresh()"
					[disabled]="loading() || importState.isImporting()"
				>
					<mat-icon aria-hidden="true">refresh</mat-icon>
					Refresh accounts
				</button>

				@if (importState.isImporting()) {
					<!--
						Inline status indicator:
						- The page itself is the "import console", so we avoid any modal UI here.
						- Navigation is guarded by `importInProgressGuard` to keep the user focused on the batch.
					-->
					<span class="import__running">
						<span class="app-pill">RUNNING</span>

						<!-- Spinner: visible for the whole batch duration. -->
						<mat-progress-spinner
							diameter="14"
							mode="indeterminate"
							aria-label="Import in progress"
						></mat-progress-spinner>

						<span class="import__running-text">Import in progress…</span>
					</span>
				}
			</div>

			<!-- Import scope/rules (kept visible but collapsible for quick access). -->
			<mat-expansion-panel
				class="import__rules"
				[expanded]="importRulesExpanded()"
				(expandedChange)="setImportRulesExpanded($event)"
			>
				<mat-expansion-panel-header>
					<mat-panel-title>
						<span class="import__rules-title">
							<mat-icon class="import__rules-icon" aria-hidden="true">info</mat-icon>
							<span>What gets imported</span>
						</span>
					</mat-panel-title>

					<mat-panel-description> Rated · Standard · Bullet/Blitz/Rapid </mat-panel-description>
				</mat-expansion-panel-header>

				<div class="import__rules-body">
					<p>
						To keep your database clean and focused, the importer currently fetches a curated subset
						of games:
					</p>

					<ul class="import__rules-list">
						<li><strong>Rated</strong> games only (competitive).</li>
						<li><strong>Standard chess</strong> only (no Chess960 or other variants).</li>
						<li>
							Time controls: <strong>bullet</strong>, <strong>blitz</strong>,
							<strong>rapid</strong>.
						</li>
					</ul>

					<p class="import__muted">
						Friendly/casual games, bot games, and special variants are not imported.
					</p>
				</div>
			</mat-expansion-panel>

			<!-- Batch summary: rendered only when we have a batch id (running or completed batch). -->
			@if (importState.batchId(); as bid) {
				<app-import-batch-summary
					[batchId]="bid"
					[startedAtIso]="importState.startedAtIso()"
					[finishedAtIso]="importState.finishedAtIso()"
					[maxGamesPerAccount]="importState.maxGamesPerAccount()"
					[totals]="importState.totals()"
				/>
			}
		</div>
	</div>

	<!-- List card: accounts state + table -->
	<div class="app-card-flat import__list">
		<div class="app-card-flat-content-fit import__list-content">
			<app-section-loader
				[loading]="loading()"
				mode="overlay"
				[mask]="true"
				[blocking]="true"
				label="Loading accounts…"
			>
				<!-- Browser mode: import is available in the Electron desktop app only. -->
				@if (!isDesktopApp()) {
					<div class="import__state import__state--info">
						<div class="import__empty-title">Desktop app only</div>
						<div class="import__empty-text">
							Import is available in the Electron desktop app only.
						</div>
					</div>
				} @else if (error()) {
					<!-- Errors from loading accounts/import state (best-effort message). -->
					<div class="import__state import__state--error">{{ error() }}</div>
				} @else if (tableRows().length === 0) {
					<!-- Empty state: keep it actionable with direct navigation CTAs. -->
					<div class="import__state import__empty">
						<div class="import__empty-title">No chess accounts configured</div>
						<div class="import__empty-text">
							Add at least one Chess.com or Lichess account to import games.
						</div>

						<div class="import__empty-actions">
							<a mat-stroked-button class="mat-stroked-button-d-5" routerLink="/chess-accounts">
								<mat-icon aria-hidden="true">person_add</mat-icon>
								Manage accounts
							</a>

							<a mat-stroked-button class="mat-stroked-button-d-5" routerLink="/getting-started">
								<mat-icon aria-hidden="true">help_outline</mat-icon>
								Getting started
							</a>
						</div>
					</div>
				} @else {
					<div class="app-table-card app-table-card--compact import__table-card">
						<div class="app-table-card__scroll">
							<app-import-accounts-table
								[rows]="tableRows()"
								[displayedColumns]="displayedColumns()"
								[isImporting]="importState.isImporting()"
								[actionsDisabled]="actionsDisabled()"
								(importRequested)="importOne($event)"
							/>
						</div>
					</div>
				}
			</app-section-loader>
		</div>
	</div>
</div>
