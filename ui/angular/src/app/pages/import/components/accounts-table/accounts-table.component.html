<table
	mat-table
	[dataSource]="rows"
	class="import__table"
	[trackBy]="trackById"
	aria-label="Import accounts list"
>
	<!-- site -->
	<ng-container matColumnDef="site">
		<th mat-header-cell *matHeaderCellDef>Site</th>
		<td mat-cell *matCellDef="let r">
			<span [class.import__dim]="!r.isEnabled">{{ r.siteLabel }}</span>
		</td>
	</ng-container>

	<!-- username -->
	<ng-container matColumnDef="username">
		<th mat-header-cell *matHeaderCellDef>Username</th>
		<td mat-cell *matCellDef="let r">
			<div class="import__username">
				<span [class.import__dim]="!r.isEnabled">{{ r.username }}</span>
				@if (!r.isEnabled) {
					<span class="app-pill app-pill--warn import__pill">DISABLED</span>
				}
			</div>
		</td>
	</ng-container>

	<!-- lastSyncAt -->
	<ng-container matColumnDef="lastSyncAt">
		<th mat-header-cell *matHeaderCellDef>Last sync</th>
		<td mat-cell *matCellDef="let r">
			@if (r.lastSyncAt) {
				<span [class.import__dim]="!r.isEnabled">{{ r.lastSyncAt | appIsoDateTime }}</span>
			} @else {
				<span class="import__muted">Never</span>
			}
		</td>
	</ng-container>

	<!-- newGames -->
	<ng-container matColumnDef="newGames">
		<th mat-header-cell *matHeaderCellDef>Found</th>
		<td mat-cell *matCellDef="let r">
			@if (r.isWaiting) {
				<span class="import__muted">Waiting…</span>
			} @else if (r.gamesFound != null) {
				{{ r.gamesFound }}
			} @else if (r.phase === 'FETCHING') {
				<div class="import__row-fetching">
					<mat-progress-spinner
						diameter="14"
						mode="indeterminate"
						aria-label="Fetching games"
					></mat-progress-spinner>
					<span class="import__muted">Downloading…</span>
				</div>
			} @else {
				<span class="import__muted">—</span>
			}
		</td>
	</ng-container>

	<!-- progress -->
	<ng-container matColumnDef="progress">
		<th mat-header-cell *matHeaderCellDef>Progress</th>
		<td mat-cell *matCellDef="let r" class="import__progress-cell">
			@if (r.isWaiting) {
				<div class="import__muted">Waiting…</div>
			} @else if (r.processed != null && r.gamesFound != null) {
				<div class="import__progress-top">
					<span class="mono">{{ r.processed }}/{{ r.gamesFound }}</span>
				</div>
				<mat-progress-bar
					mode="determinate"
					[value]="r.gamesFound > 0 ? (r.processed / r.gamesFound) * 100 : 0"
					aria-label="Import progress"
				></mat-progress-bar>
			} @else if (r.phase === 'FETCHING') {
				<div class="import__row-fetching">
					<mat-progress-spinner
						diameter="14"
						mode="indeterminate"
						aria-label="Downloading games"
					></mat-progress-spinner>
					<span class="import__muted">Downloading…</span>
				</div>
			} @else {
				<span class="import__muted">—</span>
			}
		</td>
	</ng-container>

	<!-- results -->
	<ng-container matColumnDef="results">
		<th mat-header-cell *matHeaderCellDef>Results</th>
		<td mat-cell *matCellDef="let r" class="import__results-cell">
			@if (r.inserted != null) {
				<div class="import__results-line mono">
					I={{ r.inserted }} &nbsp; S={{ r.skipped }} &nbsp; F={{ r.failed }}
				</div>

				@if (r.errors.length > 0) {
					<!-- Error list is intentionally small and scrollable to avoid blowing up row height. -->
					<div class="import__errors" aria-label="Import errors">
						@for (e of r.errors; track $index) {
							<div class="import__error-line" [title]="e.message">
								<span class="mono import__error-id">{{ e.externalId ?? 'unknown' }}</span>
								<span class="import__error-msg">{{ e.message }}</span>
							</div>
						}
					</div>
				}
			} @else {
				<span class="import__muted">—</span>
			}
		</td>
	</ng-container>

	<!-- status -->
	<ng-container matColumnDef="status">
		<th mat-header-cell *matHeaderCellDef>Status</th>
		<td mat-cell *matCellDef="let r">
			@if (r.isWaiting) {
				<span class="app-pill">WAITING</span>
			} @else if (r.status) {
				<span
					class="app-pill"
					[class.app-pill--error]="r.status === 'FAILED'"
					[class.app-pill--warn]="r.status === 'PARTIAL'"
				>
					{{ r.status }}
				</span>
			} @else {
				<span class="import__muted">—</span>
			}
		</td>
	</ng-container>

	<!-- actions -->
	<ng-container matColumnDef="actions">
		<th mat-header-cell *matHeaderCellDef class="import__actions-h"></th>
		<td mat-cell *matCellDef="let r" class="app-table-card__actions">
			<button
				mat-icon-button
				type="button"
				(click)="requestImport(r.id)"
				[disabled]="actionsDisabled || !r.isEnabled"
				[matTooltip]="
					isImporting ? 'Import already running' : (r.disabledReason ?? 'Import this account')
				"
				[attr.aria-disabled]="actionsDisabled || !r.isEnabled ? 'true' : null"
				aria-label="Import account"
			>
				<mat-icon aria-hidden="true">play_arrow</mat-icon>
			</button>
		</td>
	</ng-container>

	<tr mat-header-row *matHeaderRowDef="displayedColumns" class="app-table-card__sticky-header"></tr>

	<tr
		mat-row
		*matRowDef="let row; columns: displayedColumns"
		[class.import__row--disabled]="!row.isEnabled"
	></tr>
</table>
